# 合成事件

是 React 提供的一种跨浏览器的事件封装机制，它的主要目的是为了提供一种统一且高效的方式来处理浏览器事件，同时确保 React 能够更好地优化性能和跨浏览器的兼容性。它是 React 事件处理系统的核心概念之一。

## 保证了事件的一致性，兼容了不同的浏览器

React 合成事件通过对原生事件的统一封装和标准化处理，为开发者提供了一个无差别的事件处理接口。无论在 Chrome、Firefox、Safari 还是 Edge 等主流浏览器中，React 应用的事件处理逻辑都能保持一致。例如在处理 click 事件时，React 合成事件确保 event.target 属性在不同浏览器中都能准确指向触发事件的目标元素，开发者无需再手动编写复杂的兼容性代码。

## 事件委托/事件代理机制

- React 摒弃在每个 DOM 元素上单独绑定事件监听器的传统做法，改为在 DOM 树的顶层，通常为 document 对象
- react17 之前是在 document 上绑定事件监听器，react17 之后是在 root 上绑定事件监听器

设置一个统一的事件监听器。当事件触发后，借助 DOM 的事件冒泡机制，向上传播至顶层监听器。React 依据 event.target 属性，精准定位实际触发事件的目标元素，再利用预先构建的映射关系，快速找到对应的 React 组件实例，并调用相应的事件处理函数。在大型 React 应用中，若为每个元素单独绑定原生事件监听器，会导致内存资源的大量消耗，进而引发浏览器性能下降，而事件代理机制则成功化解了这一难题。以下代码展示了 React 事件代理的效果：

## 事件池化

### 1. 池化概念概述

池化（Pooling）是指在 React 的事件处理系统中，事件对象会被复用，而不是每次事件触发时都重新创建一个新的事件对象。这种做法能够节省内存并提高性能，特别是在大量事件处理场景下，比如处理高频事件（例如滚动、键盘输入等）。
React 会在事件回调执行后，将事件对象放回池中，以便后续复用。这意味着事件对象的属性和方法在事件处理完成后不再可用，因此不能在异步操作中直接使用它们。

### 2. React 事件池化的工作原理

合成事件的创建：当一个原生事件（如 click、keydown 等）被触发时，React 会通过合成事件系统创建一个 合成事件对象，这个对象是对原生事件的封装。React 会将事件对象的 type、target、nativeEvent 等属性复制到合成事件对象中。

事件对象的复用：当事件处理函数执行完毕后，React 会把合成事件对象放回池中，而不再保留它的引用。事件对象在下次触发事件时可以被复用，减少了内存的占用。

异步操作与事件池：由于事件对象被池化，事件对象在事件处理完成后会被回收。如果你需要在事件处理函数中异步访问事件对象（例如通过 setTimeout 或 Promise），就需要使用 event.persist() 来阻止事件池化，让事件对象保持引用。

### 3. 为什么要池化事件对象？

池化事件对象的主要目的是为了 **性能优化** 和 **内存节约**。在复杂的应用中，尤其是有大量动态事件（如列表渲染、频繁的用户交互等），每次都创建新的事件对象会浪费大量内存，并且增加 GC（垃圾回收）的压力。通过池化，React 可以减少内存分配和垃圾回收，提高性能。

### 4. 事件池的实现细节

React 的合成事件池化系统通过以下方式实现：

事件对象复用：每个事件对象都有一个唯一的标识符（如 click、mousemove 等）。当一个事件触发时，React 会通过标识符来检查该事件对象是否已经被池化。如果池中有未被使用的事件对象，React 会将其取出并重用。

合成事件的生命周期：每个合成事件对象都有一个生命周期。事件处理函数执行完成后，React 会将事件对象回收到池中。在这个过程中，事件对象会被重置，确保它不会被异步操作引用。

event.persist()：如果你需要在异步操作中使用事件对象（例如 setTimeout 中访问事件），可以调用 event.persist() 来让 React 取消池化机制，保留对事件对象的引用。这样你就可以在异步回调中继续访问事件对象的属性。

### 5.合成事件的属性

6. 合成事件的属性

合成事件对象和原生 DOM 事件对象非常相似，它们具有一致的 API。常见的属性有：

event.type：事件类型（如 click、keydown 等）。

event.target：事件目标，表示触发事件的元素。

event.currentTarget：当前触发事件的元素（即绑定事件处理函数的元素）。

event.preventDefault()：阻止事件的默认行为，例如阻止表单提交。

event.stopPropagation()：阻止事件向上冒泡。

event.nativeEvent：原生的浏览器事件对象（例如原生的 click 事件对象）。通过 nativeEvent，你可以访问到原生事件的所有信息。
