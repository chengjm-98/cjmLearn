## ä»€ä¹ˆæ˜¯ effectList

effectList æ˜¯ React ä¸­ç”¨äº**è®°å½•å‰¯ä½œç”¨çš„é“¾è¡¨**ã€‚
effect list æ˜¯ä¸€æ¡**é“¾è¡¨**ï¼ˆé€šè¿‡ nextEffect æŒ‡é’ˆä¸²èµ·æ¥ï¼‰ï¼Œç”¨äºåœ¨ commit é˜¶æ®µ æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œéœ€è¦å‰¯ä½œç”¨ï¼ˆDOM æ’å…¥/åˆ é™¤/æ›´æ–°ã€ç”Ÿå‘½å‘¨æœŸå›è°ƒã€refã€useLayoutEffect/useEffect ç­‰ï¼‰çš„ Fiber èŠ‚ç‚¹ã€‚
å®ƒç”± renderï¼ˆæ„å»º WIP æ ‘ï¼‰é˜¶æ®µ æ”¶é›†å¹¶é™„ç€åˆ°å®Œæˆçš„ finishedWorkï¼ˆworkInProgress å®Œæˆåçš„æ ‘ï¼‰ä¸Šï¼Œcommit é˜¶æ®µç›´æ¥æ²¿ç€è¿™æ¡é“¾è¡¨éå†æ‰§è¡Œå‰¯ä½œç”¨ï¼Œè€Œä¸ç”¨å†éå†æ•´æ£µæ ‘ã€‚
ğŸ’‹**ç®€è€Œè¨€ä¹‹æ˜¯ä¸€ä»½æ¸…å•ï¼Œç”¨äº commit çš„æ¸…å•ï¼Œè®°å½•äº†å“ªäº›éœ€è¦æ›´æ–°**

## é‚£ä¹ˆä»€ä¹ˆæ˜¯å‰¯ä½œç”¨ï¼Ÿ

åœ¨ React Fiber é‡Œï¼Œå‰¯ä½œç”¨ï¼ˆeffectï¼‰æŒ‡çš„æ˜¯ render è®¡ç®—â€œå®Œè™šæ‹Ÿ UIâ€ä¹‹å¤–ï¼Œè¿˜éœ€è¦åšçš„äº‹æƒ…ï¼Œä¾‹å¦‚ï¼š

- DOM æ’å…¥ / åˆ é™¤ / å±æ€§æ›´æ–°
- ref çš„èµ‹å€¼ / æ¸…ç†
- ç”Ÿå‘½å‘¨æœŸï¼ˆcomponentDidMount/Updateã€getSnapshotBeforeUpdate ç­‰ï¼‰
- Hook çš„ effectï¼ˆuseLayoutEffect/useEffectï¼‰

**ã€Œé™¤äº†æ•°æ®æ›´æ–°å¤–ã€**å¯ä»¥è¿™ä¹ˆç†è§£ï¼š
æ•°æ®æ›´æ–°æœ¬èº«ï¼ˆnewStateï¼‰å‘ç”Ÿåœ¨ render é˜¶æ®µï¼Œå±äºè®¡ç®— fiber æ ‘ã€‚
å‰¯ä½œç”¨æ˜¯ä¸ºäº†è®©è¿™æ¬¡è®¡ç®—ç»“æœåæ˜ åˆ°çœŸå®ç¯å¢ƒï¼ˆDOM / refs / ç”¨æˆ·å›è°ƒç­‰ï¼‰ä¸­å»ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦ effectList

æ¸²æŸ“ï¼ˆrenderï¼‰é˜¶æ®µæ˜¯å¯ä¸­æ–­çš„ï¼Œcommit é˜¶æ®µæ˜¯ä¸å¯ä¸­æ–­çš„ã€‚ä¸ºäº†é«˜æ•ˆæŠŠâ€œéœ€è¦åšå‰¯ä½œç”¨çš„èŠ‚ç‚¹â€æŒ‰æ­£ç¡®é¡ºåºè®°å½•ä¸‹æ¥ï¼ŒReact åœ¨æ¸²æŸ“æœŸé—´æ„å»ºè¿™æ¡é“¾è¡¨ï¼Œcommit æ—¶ç›´æ¥éå†å³å¯ï¼Œé¿å…é‡æ–° DFS æ•´æ£µæ ‘ï¼Œæé«˜æ•ˆç‡å¹¶ä¿è¯é¡ºåºæ­£ç¡®æ€§ã€‚

## effectList çš„ç»“æ„å’Œé¡ºåº

- ç”Ÿæˆæ–¹å¼
  åœ¨ render é˜¶æ®µï¼ŒFiber æ ‘æ„å»ºå®Œæˆä¹‹åï¼ŒReact ä¼šæŠŠå¸¦æœ‰å‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹ï¼ˆæ¯”å¦‚ Placementã€Updateã€Deletion ç­‰ï¼‰ä¸²æˆä¸€æ¡ effectList å•å‘é“¾è¡¨ï¼Œé“¾è¡¨çš„é¡ºåºæ¥è‡ª æ·±åº¦ä¼˜å…ˆéå†ï¼ˆDFSï¼‰ Fiber æ ‘çš„é¡ºåºï¼š
  éå†æ—¶å…ˆèµ° å­èŠ‚ç‚¹ â†’ å†èµ° å…„å¼ŸèŠ‚ç‚¹ â†’ æœ€åå›åˆ° çˆ¶èŠ‚ç‚¹ã€‚
  å› æ­¤ effectList çš„é¡ºåºå°±æ˜¯ å…ˆå­åçˆ¶ã€‚
- commit é˜¶æ®µçš„æ‰§è¡Œé¡ºåº
  åœ¨ commit é˜¶æ®µï¼Œå‰¯ä½œç”¨çš„æ‰§è¡Œéµå¾ª effectList çš„é¡ºåºï¼šDOM æ’å…¥ / æ›´æ–° / åˆ é™¤ï¼ˆmutation é˜¶æ®µï¼‰ä¹Ÿæ˜¯å…ˆå­åçˆ¶ã€‚Layout Effect å’Œ Passive Effect çš„è§¦å‘ï¼Œä¹Ÿæ²¿ç”¨è¿™ä¸ªé¡ºåºã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```jsx
function Child({ value }) {
  useLayoutEffect(() => {
    console.log("Child Layout");
  });
  return <div>{value}</div>;
}

function Parent({ count }) {
  useLayoutEffect(() => {
    console.log("Parent Layout");
  });
  return <Child value={count} />;
}
```

- ç»“æœï¼šæ›´æ–° count æ—¶çš„è¾“å‡ºé¡ºåºï¼š
  Child Layout
  Parent Layout

- å­ç»„ä»¶æ˜¯å¦æ—©äºçˆ¶ç»„ä»¶ï¼Ÿ
  åˆ†ä¸¤ç§æƒ…å†µï¼š
  è¦åˆ†æƒ…å†µè®¨è®ºï¼š

  - æ¸²æŸ“é¡ºåºï¼š
    Reconciliation é˜¶æ®µæ—¶ï¼Œçˆ¶ Fiber ä¼šå…ˆè¢«å¤„ç†ï¼ˆå› ä¸ºå®ƒåŒ…å« props æ”¹å˜ï¼‰ï¼Œä½† React ä¼šè¿›å…¥å®ƒçš„å­æ ‘é€’å½’æ„å»ºæ–° Fiber â†’ æ‰€ä»¥å­ç»„ä»¶çš„ render ç¡®å®åœ¨çˆ¶ç»„ä»¶ commit å‰¯ä½œç”¨ä¹‹å‰å®Œæˆã€‚

  - å‰¯ä½œç”¨æ‰§è¡Œé¡ºåºï¼š
    æäº¤é˜¶æ®µæ—¶ï¼ŒeffectList ä¿è¯ å­ç»„ä»¶çš„å‰¯ä½œç”¨å…ˆæ‰§è¡Œï¼Œå†æ‰§è¡Œçˆ¶ç»„ä»¶ã€‚
  - æ‰€ä»¥å¯ä»¥æ€»ç»“ï¼š
    - render é˜¶æ®µï¼šçˆ¶å…ˆå¼€å§‹ â†’ å­ â†’ å›åˆ°çˆ¶ã€‚
    - commit é˜¶æ®µï¼šeffectList å†³å®šå‰¯ä½œç”¨ å­å…ˆçˆ¶åã€‚

## effect List å’Œ updateQueue çš„å…³ç³»

- updateQueue æ˜¯ä»€ä¹ˆ
- updateQueue æ˜¯æ›´æ–°å¯¹è±¡çš„é˜Ÿåˆ—ï¼Œæ¯ä¸ª update å¯¹è±¡è®°å½•ä¸€æ¬¡ state/props/context/forceUpdate çš„æ›´æ–°è¯·æ±‚ã€‚å®ƒçš„ä½œç”¨æ˜¯ åœ¨ render é˜¶æ®µè®¡ç®— fiber çš„æ–° state/propsã€‚
- æ‰€ä»¥ updateQueue æœåŠ¡äº render é˜¶æ®µçš„ â€œè®¡ç®—å·¥ä½œâ€ã€‚
  ä¸¾ä¸ª ğŸŒ°ï¼š

```jsx
this.setState({ count: this.state.count + 1 });
```

ä¼šç”Ÿæˆä¸€ä¸ª update â†’ append åˆ° fiber çš„ updateQueueã€‚
åœ¨ render é˜¶æ®µï¼ŒReact ä¼šä» updateQueue é‡Œå–å‡ºæ‰€æœ‰ updateï¼Œè®¡ç®—å‡ºæœ€ç»ˆçš„ nextStateï¼Œç„¶åç”Ÿæˆæ–°çš„ fiber èŠ‚ç‚¹ã€‚

- effect list æ˜¯ä»€ä¹ˆ
- effect list æ˜¯å‰¯ä½œç”¨é“¾è¡¨ï¼Œåœ¨ render é˜¶æ®µï¼ˆcompleteWorkï¼‰æ‹¼æ¥å‡ºæ¥ã€‚å®ƒè®°å½•çš„æ˜¯ å“ªäº› fiber åœ¨ commit é˜¶æ®µè¦åšå‰¯ä½œç”¨ã€‚
- commit é˜¶æ®µ React ç›´æ¥éå† effect listï¼Œè€Œä¸ç”¨éå†æ•´æ£µ fiber æ ‘ã€‚
  ä¸¾ä¸ª ğŸŒ°ï¼š

```jsx
this.setState({count: this.state.count + 1});
<div>{this.state.count}</div>~
```

è¿™æ ·å¦‚æœæœ‰å‰¯ä½œç”¨äº§ç”Ÿï¼Œæ¯”å¦‚è¿™ä¸ª ğŸŒ° ä¸­ï¼Œæœ‰ dom çš„å˜åŒ–ï¼Œå°±ä¼šäº§ç”Ÿ updateQueueã€‚
