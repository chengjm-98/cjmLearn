# Fiber 是什么?什么是 fiber 节点

- Fiber
  - Fiber 是 React 的新一代调度架构，可中断、可恢复、可优先级调度的虚拟 DOM 架构
- Fiber 节点
  - Fiber 节点 是一个 链表结构的对象节点
  - 调度单元/工作单元

# fiber 解决了什么问题

- 1.diff 算法不能中断的问题，导致页面掉帧卡顿
- 2.优先级/可中断/可恢复

# 为什么 fiber 可以实现中断和恢复

- 1.数据结构支持中断，单独的渲染单元
  - 链表结构 child/sibling/return，可随时挂起，保存当前节点状态。
  - 拆分单独的渲染单元，单独计算不会依赖整棵树。渲染完成后可以随时记录当前 Fiber（nextUnitOfWork），中断后下次直接从 nextUnitOfWork 继续
- 2.调度器 Scheduler 时间切片
  - shouldYield() 判断浏览器空闲时间超时暂停，空闲再恢复
  - 支持优先级调度 lane，可以随时挂起低优先级任务。

# 两大阶段

- 1.render 阶段
  - 负责构建 work-in-progress 树和收集副作用（effectlist）。它本身可中断，但需要 Scheduler 来调度执行，Scheduler 根据优先级（lane）和时间片来控制 Render 阶段的开始、暂停和恢复
- 2.commit 阶段 不可中断
  - 切换 Fiber 树 root.current = finishedWork 完成双缓存切换
  - Before Mutation
    - 执行 getSnapshotBeforeUpdate
    - DOM 尚未变更
  - Mutation（DOM 变更阶段）
    - 执行 Placement / Update / Deletion
    - 操作真实 DOM
  - Layout（同步副作用）
    - 执行 useLayoutEffect
    - 执行 componentDidMount / Update
    - 绑定 ref
  - 绘制
  - Passive（异步副作用）
    - 执行 useEffect 回调
    - 浏览器已经渲染页面
  - 可以触发下一轮状态更新
    所以 useeffect 是异步的不会阻塞绘制渲染，useLayoutEffect 是同步的，会阻塞渲染绘制，useLayoutEffect 阻塞的不是 commit，而是绘制。
  ```jsx
  root.current = finishedWork; // finishedWork = workInProgress
  currentFiber.alternate → workInProgressFiber
  workInProgressFiber.alternate → currentFiber
  ```

# 双缓冲

- **current** （当前页面显示的）
- **workInProgress** （正在计算的新树）
- 当 workInProgress 树构建完成后，将 workInProgress 树赋值给 current 树，然后将 workInProgress 树重置为 null，这样就完成了一次渲染过程。
