<!--
 * @Author: error: error: git config user.name & please set dead value or install git && error: git config user.email & please set dead value or install git & please set dead value or install git
 * @Date: 2025-12-18 21:10:12
 * @LastEditors: error: error: git config user.name & please set dead value or install git && error: git config user.email & please set dead value or install git & please set dead value or install git
 * @LastEditTime: 2025-12-30 18:42:54
 * @FilePath: /cjmLearn/webpack概念/热更新.md
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
-->
# 热更新（HMR）

- 允许在浏览器中实时替换模块而无需刷新页面。这样可以在不丢失应用状态的情况下快速查看代码修改效果。

## 主要特点：

- 模块热替换（HMR）：只更新修改的模块，而不是整个页面，不需要重新加载整个 bundle，只替换发生变化的模块。
- 快速反馈：在保存文件后，模块会被重新编译和热替换，开发者可以立即看到修改后的效果。
- 保持应用状态:由于是局部更新，因此不会丢失应用程序的状态（例如用户输入的表单数据、页面滚动位置等）。

## 适用(意义，为什么)

- 之前的状态： 改代码 → webpack 重新打包 → 浏览器整页刷新 → 状态丢失
- HMR 想解决的问题 不刷新页面的状态下，在浏览器上更新修改过的模块。

- Webpack 的热更新（HMR）主要用于开发阶段，尤其适合本地开发和联调环境，生产环境一般不使用。

- **本质上**就是开发体验工具
- HMR = Webpack 在浏览器里运行了一套 **「模块热替换运行时系统」**

```jsx
它不是「自动刷新」，而是：

Webpack 在 浏览器端

维护了一张 模块依赖图

能够 下载更新后的模块

并在运行时 替换旧模块
```

## 实现原理（具体流程）

- 1. webpack dev server
  - 启动一个本地开发服务器，监听代码变化。
  - DevServer 会在文件变动时重新构建，并通过 WebSocket 或长轮询通知浏览器，告诉它文件已经发生变化。
- 2. 代码发生变化
  - Webpack 启动时，watch 模式（通过 compiler.watch(...)）会监听源代码中的文件变化。
  - 当开发者修改了源代码（例如，修改了 src/index.js），Webpack 会检测到文件的变化，触发增量编译。
    - 增量编译：增量编译 意味着 Webpack 并不会重新打包所有的文件，而是只会对变更的文件和与之相关的模块进行重新编译。这大大提高了开发时的构建效率。
- 3. 编译完成，生成热更新文件，通知浏览器更新
  - Webpack 在编译完成后，会生成 Hot Update 文件（通常是 .hot-update.js 和 .hot-update.json），这些文件包含了更新模块的差异和最新的内容。
  - Webpack 会通过 WebSocket 向浏览器发送一个更新通知，告知浏览器某些模块发生了变化。
- 4. 浏览器进行模块替换
  - Webpack Runtime 在浏览器端通过 webpack/hot/dev-server.js 和 module.hot 来处理热更新过程。
  - 浏览器接收到 Hot Update 文件后，决定哪些模块需要替换。对于支持热更新的模块（通过 module.hot.accept() 标明），Webpack 会执行模块热替换（Hot Module Replacement, HMR）

  - 热更新流程：
    - 接收更新：浏览器通过 WebSocket 接收 Webpack 发送的 hot-update 文件（.hot-update.js 和 .hot-update.json）。
    - 模块替换：浏览器通过 Webpack 提供的 **webpack_require** 函数加载更新的模块，并进行替换。
      - 通过 module.hot.accept() 确保只有发生变化的模块被替换。
    - 模块执行：替换后，模块的回调函数会被执行，通常是更新 UI 或重渲染组件。
  - 如果模块不支持热更新：
    - Webpack 会检测到 module.hot.accept() 是否被调用，如果没有，浏览器会触发 全页面刷新。

## 实现的关键点

- module.hot.accept
  module.hot.accept 是 Webpack 提供的 API，用于接收热更新。在模块更新时，它会触发回调函数，而不会导致全局页面刷新。
  ```js
  if (module.hot) {
    module.hot.accept("./module", function () {
      console.log("Module updated!");
    });
  }
  ```
- module.hot.dispose
  module.hot.dispose 用于在模块更新之前清理当前模块的状态，例如移除事件监听器、清理定时器等。它可以避免多个热更新的状态叠加。
  ```js
  if (module.hot) {
    module.hot.dispose(function () {
      console.log("Module disposed!");
    });
  }
  ```
- webpack-dev-server 和 WebSocket
  - webpack-dev-server 是一个本地开发服务器,它会通过 websocket 与浏览器建立连接,接受 webpack 编译后的更新信息。
  - websocket 连接保持在浏览器和服务器中间，一旦文件发生变更，服务器会通知浏览器，浏览器接收到通知后，会向服务器请求更新的文件。

## HMR 支持的模块类型

- js 模块 对于 js 模块，webpack 有个 module.hot API，可以用于判断模块是否支持热更新。
- css 模块 对于 css 模块，可以通过 style-loader 和 css-loader 来实现热更新。
- react
- vue
  但是某些模块（非模块化的外部库）是不支持热更新的
