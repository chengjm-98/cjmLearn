# 解耦的关键

- 埋点一定“有接口”，但前端永远不应该感知它
- 埋点一定会影响性能，但可以被设计成“几乎无感”

# 什么是 dataLayer 配合 Google Tag Manager 使用？

你可以结合 数据层（DataLayer） 和一些自动化工具（如 Google Tag Manager）来简化手动埋点的工作。数据层的作用是将用户行为数据存放在一个全局对象中，开发者不需要手动为每个元素添加埋点事件，只需要通过事件推送到数据层，然后由工具自动收集和发送。

# sdk 配合 navigator.sendBeacon(url, data)

- navigator.sendBeacon() 是浏览器提供的一个用于在页面卸载（关闭/跳转）时可靠发送少量数据的 API，常用于埋点、日志、统计等场景。
- 控制频率，节流/去重
- 优先级，缓存
- SDK 必须“异步 + 非阻塞” 埋点低优先级，业务逻辑优先级最高。

## 具体设计

```jsx
┌──────────────┐
│  业务代码     │
│  Tracker.track│
└──────┬───────┘
     ↓
┌────────────────────┐
│   埋点 SDK Core     │
│ ┌───────────────┐  │
│ │ 事件标准化     │  │
│ │ 队列 & 频控    │  │
│ │ 批量策略       │  │
│ │ 生命周期监听   │  │
│ └───────────────┘  │
└──────┬─────────────┘
     ↓
┌────────────────────┐
│ 上报通道（黑盒）     │
│ sendBeacon / img    │
└────────────────────┘
     ↓
 埋点接收服务

```

## 具体代码

- 业务层面

```jsx
Tracker.init({
  appId: 'xxx',
  endpoint: '/track'
});

<button data-track="click_login">登录</button>

document.addEventListener('click', (e) => {
  const el = (e.target as HTMLElement).closest('[data-track]');
  if (!el) return;

  Tracker.track(el.dataset.track!);
});

```

- sdk
- 事件模型标准化（第一步）
- 内存队列（解耦 & 缓冲）,这里绝对不能发请求
- 批量 + 防抖调度（性能关键）
- 页面卸载兜底
- 高频事件节流
