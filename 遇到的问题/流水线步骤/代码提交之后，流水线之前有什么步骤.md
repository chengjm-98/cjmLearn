# 代码提交

# 打包/部署/镜像/容器配置/发到服务器

# 发布

```jsx
#!groovy
import org.jenkinsci.plugins.plaincredentials.StringCredentials
repoURL = "ssh://vcssh@phabricator.intern.yuansuan.cn/diffusion/62/cae.git"
repoPath = "/opt/jenkins/workspace/gw-ca-full-fe"
Workdir = "/opt/jenkins/workspace/gw-ca-full-fe/ca-full/frontend"
pipeline {
    agent {label 'tstage'}
    stages {
        stage('clean') {
            steps {
                    sh"""
                        rm -rf ${repoPath}
                        mkdir -p ${repoPath}
                    """
            }
        }
        stage('clone') {
            steps {
                script {
                    if("${envs}" == "dev") {
                        sh"""
                            git clone --depth 1 ${repoURL} ${repoPath}
                        """
                    }else if("${envs}" == "stage") {
                        sh"""
                            git clone --branch ca-full-${BUILD_NUMBER} --depth 1 ${repoURL} ${repoPath}
                        """
                    }
                }
            }
        }
        stage('build') {
            steps {
                echo "版本号:${BUILD_NUMBER}"
                echo '开始打包.'
                sh"""
                cd ${Workdir}
                docker login -u admin -p yskj2407 1.117.192.82:8666
                docker build -t 1.117.192.82:8666/ca-full/ca-full-fe:${BUILD_NUMBER} .
                docker push 1.117.192.82:8666/ca-full/ca-full-fe:${BUILD_NUMBER}
                """
                echo '打包完成.'
                script {
                    if("${envs}" == "dev") {
                        sh "ssh tdev \"mkdir -p /opt/ca-full/front\""
                    }else if("${envs}" == "stage") {
                        sh "mkdir -p /opt/ca-full/front"
                    }
                }
                echo 'build end.'
            }
        }
        stage('deploy') {
            steps {
                echo 'deploy start.'
                    script {
                    if( "${envs}" == "dev" ) {
                        sh "scp  ${Workdir}/nginx/fe_tdev.conf tdev:/opt/ca-full/front/"
                        sh "scp  ${Workdir}/nginx/nginx.conf tdev:/opt/ca-full/front/"
                        sh "ssh tdev \"docker rm -f ca-full-fe || true\""
                        sh "ssh tdev \"docker image prune -a -f || true\""
                        sh "ssh tdev \"docker login -u admin -p yskj2407 1.117.192.82:8666\""
                        sh "ssh tdev \"docker pull 1.117.192.82:8666/ca-full/ca-full-fe:${BUILD_NUMBER}\""
                        sh "ssh tdev \"docker run -itd -p 8056:8056 -v /opt/ca-full/front/nginx.conf:/etc/nginx/nginx.conf -v /opt/ca-full/front/fe_tdev.conf:/etc/nginx/conf.d/default.conf  --restart=always  --name ca-full-fe 1.117.192.82:8666/ca-full/ca-full-fe:${BUILD_NUMBER}\""
                    }else if( "${envs}" == "stage" ){
                        sh "cp -r ${Workdir}/nginx/fe_tstage.conf /opt/ca-full/front/"
                        sh "cp -r ${Workdir}/nginx/nginx.conf /opt/ca-full/front/"
                        sh "docker rm -f ca-full-fe || true"
                        sh "docker login -u admin -p yskj2407 1.117.192.82:8666"
                        sh "docker pull 1.117.192.82:8666/ca-full/ca-full-fe:${BUILD_NUMBER}"
                        sh "docker run -itd  -p 8056:8056 -v /opt/ca-full/front/nginx.conf:/etc/nginx/nginx.conf -v /opt/ca-full/front/fe_tstage.conf:/etc/nginx/conf.d/default.conf  --restart=always --name ca-full-fe 1.117.192.82:8666/ca-full/ca-full-fe:${BUILD_NUMBER}"
                    }
                }
                echo 'deploy end.'
            }
        }
        stage('report') {
            steps {
                echo 'Build && Test succeeded.'
                echo "http://10.0.4.66:8056/?ticket=569619c5-6100-4f35-a5fb-43fc2ade667f"
                echo "http://10.0.4.67:8056/?ticket=569619c5-6100-4f35-a5fb-43fc2ade667f"
                echo "${BUILD_NUMBER}"
            }
        }
    }
}

```
