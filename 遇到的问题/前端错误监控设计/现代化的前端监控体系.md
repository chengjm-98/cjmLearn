# 错误监控是什么

- 前端监控不应该是简单的报错系统，而是体验基础设施
  - 采集层
  - 调度层
  - 数据上报层
  - 数据处理
  - 分析/可视化/告警

# 具体指标

- 性能指标
- 主线程健康度指标
- 交互性能指标
- 稳定性指标
- 架构质量指标

# 参与决策/告警

| -       | 指标    | 阈值 |
| ------- | ------- | ---- |
| LCP P75 | < 2.5s  |
| INP P75 | < 200ms |
| 错误率  | < 0.1%  |
| 白屏率  | < 0.01% |
| 卡顿率  | < 3%    |

# 设计数据的优先级

| 优先级 | 类型              |
| ------ | ----------------- |
| P0     | 白屏、崩溃        |
| P1     | JS 错误、资源失败 |
| P2     | INP 超标          |
| P3     | 性能指标          |

# 具体如何获取这些指标

## 性能指标

- 浏览器 api
  | API | 能力 |
  | ------------------------------- | ----------- |
  | PerformanceObserver | 监听性能事件 |
  | performance.timing / navigation | 页面生命周期 |
  | web-vitals 标准 | Google 官方算法 |
- 获取 fp/fpc

```jsx
const observer = new PerformanceObserver((list) => {
  for (const entry of list.getEntries()) {
    if (entry.name === "first-paint") {
      report("FP", entry.startTime);
    }
    if (entry.name === "first-contentful-paint") {
      report("FCP", entry.startTime);
    }
  }
});

observer.observe({ type: "paint", buffered: true });
```

## 主线程健康度指标

| 指标            | 计算方式                    |
| --------------- | --------------------------- |
| LongTask 总耗时 | Σ duration                  |
| LongTask 次数   | entries.length              |
| 最大 LongTask   | Math.max                    |
| 卡顿率          | LongTaskTime / 页面活跃时间 |
| 脚本归因        | attribution.name            |

```jsx
const observer = new PerformanceObserver((list) => {
  list.getEntries().forEach((entry) => {
    report("longtask", {
      duration: entry.duration,
      startTime: entry.startTime,
      attribution: entry.attribution,
    });
  });
});
observer.observe({ type: "longtask", buffered: true });
```

## 交互性能指标

- 埋点上报/点击/搜索
- Event Timing API
- PerformanceObserver

## 稳定性指标

| 错误类型             | 捕获方式                                                | 说明                                 |
| -------------------- | ------------------------------------------------------- | ------------------------------------ |
| JS 运行时错误        | `window.onerror`                                        | 捕获语法错误、引用错误、未捕获异常等 |
| Promise 异常         | `window.onunhandledrejection`                           | 捕获未被 `catch` 的 Promise reject   |
| 资源加载失败         | `window.addEventListener('error', fn, true)`            | 捕获 img/script/link 等资源加载失败  |
| Vue/React 框架错误   | Vue: `app.config.errorHandler` <br>React: ErrorBoundary | 捕获组件渲染错误                     |
| 网络请求失败         | 封装 fetch/axios                                        | 捕获接口请求失败或超时               |
| 用户行为埋点（可选） | 自定义函数                                              | 捕获用户操作路径，便于复现问题       |

```jsx
白屏检测;
function detectWhiteScreen() {
  const elements = document.body.children;
  if (!elements.length) report("whiteScreen");
}
```

# 上报策略

- 低优先级的，批量上报或者使用缓存
  - requestIdleCallback
  - IndexedDB 缓存
- 离开页面或者关闭浏览器的时候
  - navigator.sendBeacon
- 高优先级的，立即上报
  - 白屏、崩溃、JS 错误、资源失败、INP 超标、性能指标
  - 上报模块的标准接口
  ```jsx
  interface Transport {
    send(payload: any, options?: { immediate?: boolean })
    flush()
  }
  ```
