# abortController 取消请求

可以多个请求共享同一个 AbortController 来批量中断。

## 可以中断的时机

- AbortController 可以中断请求的任何阶段
  | 阶段 | 已发出？ | AbortController 行为 |
  | ----------- | ---- | --------------------------------- |
  | 请求尚未发送 | ❌ | 不发出请求，Promise reject |
  | 请求已发出，未返回响应 | ✅ | 停止接收响应，Promise reject |
  | 请求已开始接收响应 | ✅ | 停止接收剩余数据，Promise reject / onabort |

# XMLHttpRequest（XHR）

使用 abort()方法来中断请求。

# axios 请求

- 之前使用的是 cancelToken，现在已经被废弃了，推荐使用 abortController。
- 内部调用的还是 abort()方法。

# 中断请求的适用场景

- 用户操作切换
  - 比如搜索输入框的 debounce，每次输入都发请求，取消上一次请求。
- 组件卸载
  - React/ Vue 组件卸载时取消未完成请求，避免 setState 报错或内存泄漏。
- 节省流量/优化性能
  - 避免无用请求占用网络。

# 实现原理

- AbortController 信号
- signal 是一个事件信号对象（EventTarget）
- controller.abort() 会触发 signal.aborted = true，并发出 abort 事件
- fetch 监听 signal
- fetch 内部注册了 signal 的监听器
- 一旦收到 abort 信号，内部会调用 底层 fetch 实现的中止逻辑
- 停止网络请求
- 对浏览器实现：底层可能是调用 XHR 或原生网络模块
- 已发送的数据可能被服务器处理，但浏览器不再接收
- Promise reject 并抛出 AbortError
